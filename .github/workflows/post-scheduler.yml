name: RobCo Weather Watch — Post Scheduler

on:
  schedule:
    # Runs every 5 minutes
    - cron: '*/5 * * * *'
  workflow_dispatch: # allow manual trigger

jobs:
  post-scheduled:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed to delete post files after publishing

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Check for scheduled posts and publish
        env:
          META_SYSTEM_TOKEN: ${{ secrets.META_SYSTEM_TOKEN }}
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
        run: |
          python3 << 'PYEOF'
          import os, json, base64, time, glob, subprocess
          from datetime import datetime, timezone
          import urllib.request, urllib.parse

          SYSTEM_TOKEN = os.environ.get("META_SYSTEM_TOKEN","").strip()
          PAGE_ID = os.environ.get("FB_PAGE_ID","").strip()

          API = "https://graph.facebook.com/v21.0"
          NOW = datetime.now(timezone.utc)

          def api_post(url, data=None, files=None):
              if files:
                  import http.client
                  boundary = "----RobCoFormBoundary" + str(int(time.time()))
                  body = b""
                  for k, v in (data or {}).items():
                      body += f"--{boundary}\r\nContent-Disposition: form-data; name=\"{k}\"\r\n\r\n{v}\r\n".encode()
                  for k, (fname, fdata, ftype) in files.items():
                      body += f"--{boundary}\r\nContent-Disposition: form-data; name=\"{k}\"; filename=\"{fname}\"\r\nContent-Type: {ftype}\r\n\r\n".encode()
                      body += fdata + b"\r\n"
                  body += f"--{boundary}--\r\n".encode()

                  parsed = urllib.parse.urlparse(url)
                  conn = http.client.HTTPSConnection(parsed.netloc)
                  conn.request(
                      "POST",
                      parsed.path + ("?" + parsed.query if parsed.query else ""),
                      body,
                      {"Content-Type": f"multipart/form-data; boundary={boundary}"}
                  )
                  resp = conn.getresponse()
                  return json.loads(resp.read())
              else:
                  encoded = urllib.parse.urlencode(data or {}).encode()
                  req = urllib.request.Request(url, data=encoded, method="POST")
                  req.add_header("Content-Type", "application/x-www-form-urlencoded")
                  with urllib.request.urlopen(req) as resp:
                      return json.loads(resp.read())

          def api_get(url):
              with urllib.request.urlopen(url) as resp:
                  return json.loads(resp.read())

          def delete_post_file(filepath):
              subprocess.run(["git", "config", "user.email", "action@github.com"], check=True)
              subprocess.run(["git", "config", "user.name",  "GitHub Action"],      check=True)
              subprocess.run(["git", "rm", filepath], check=True)
              subprocess.run(["git", "commit", "-m", f"Published and removed {filepath}"], check=True)
              subprocess.run(["git", "push"], check=True)

          def get_page_access_token():
              # Get a Page Access Token via System User token
              url = f"{API}/{PAGE_ID}?fields=access_token&access_token={urllib.parse.quote(SYSTEM_TOKEN)}"
              data = api_get(url)
              token = data.get("access_token","")
              if not token:
                  raise Exception("Failed to fetch Page access_token. Response: " + json.dumps(data))
              return token

          if not SYSTEM_TOKEN or not PAGE_ID:
              print("ERROR: Missing META_SYSTEM_TOKEN or FB_PAGE_ID secrets.")
              raise SystemExit(1)

          page_token = get_page_access_token()
          print("Got Page token via system token.")

          # Find all scheduled post files
          post_files = glob.glob("scheduled-posts/*.json")
          if not post_files:
              print("No scheduled posts found.")
              raise SystemExit(0)

          for filepath in post_files:
              try:
                  with open(filepath, "r", encoding="utf-8") as f:
                      post = json.load(f)

                  scheduled_at = datetime.fromisoformat(post["scheduled_at"].replace("Z","+00:00"))
                  if scheduled_at > NOW:
                      remaining = (scheduled_at - NOW).total_seconds() / 60
                      print(f"SKIP {filepath} — scheduled in {remaining:.1f} min")
                      continue

                  print(f"POSTING {filepath} — was scheduled for {scheduled_at}")

                  caption  = post.get("caption","")
                  do_fb    = post.get("platforms",{}).get("facebook", True)
                  do_ig    = post.get("platforms",{}).get("instagram", True)

                  # Prefer image_url (new tool). Fallback to legacy base64.
                  image_url = (post.get("image_url") or "").strip()
                  image_bytes = None
                  if not image_url:
                      image_b64 = post.get("image_jpeg_b64","")
                      if not image_b64:
                          print(f"ERROR: No image_url or image_jpeg_b64 in {filepath}")
                          continue
                      try:
                          image_bytes = base64.b64decode(image_b64)
                          print("Using legacy base64 image.")
                      except Exception as e:
                          print(f"ERROR: Bad base64 in {filepath}: {e}")
                          continue
                  else:
                      print(f"Using image_url: {image_url}")

                  # ── Facebook ──
                  if do_fb:
                      try:
                          if image_url:
                              result = api_post(
                                  f"{API}/{PAGE_ID}/photos",
                                  data={
                                      "url": image_url,
                                      "caption": caption,
                                      "published": "true",
                                      "access_token": page_token
                                  }
                              )
                          else:
                              result = api_post(
                                  f"{API}/{PAGE_ID}/photos",
                                  data={"message": caption, "published": "true", "access_token": page_token},
                                  files={"source": ("forecast.jpg", image_bytes, "image/jpeg")}
                              )

                          if "error" in result:
                              print(f"FB ERROR: {result['error'].get('message')}")
                          else:
                              post_id = result.get("post_id") or result.get("id","")
                              fb_post_url = f"https://www.facebook.com/{post_id.replace('_','/posts/')}" if post_id else ""
                              print(f"Facebook posted OK — {fb_post_url}")
                      except Exception as e:
                          print(f"Facebook exception: {e}")

                  # ── Instagram ──
                  if do_ig:
                      try:
                          page_data = api_get(f"{API}/{PAGE_ID}?fields=instagram_business_account&access_token={page_token}")
                          ig_id = page_data.get("instagram_business_account",{}).get("id")
                          if not ig_id:
                              print("IG: No Instagram Business account linked")
                          else:
                              ig_image_url = image_url

                              if not ig_image_url:
                                  # Legacy fallback: upload unpublished to FB to get a public source URL
                                  photo_res = api_post(
                                      f"{API}/{PAGE_ID}/photos",
                                      data={"published": "false", "access_token": page_token},
                                      files={"source": ("forecast.jpg", image_bytes, "image/jpeg")}
                                  )
                                  if "error" in photo_res:
                                      print(f"IG upload error: {photo_res['error'].get('message')}")
                                      ig_image_url = None
                                  else:
                                      photo_id = photo_res["id"]
                                      img_data = api_get(f"{API}/{photo_id}?fields=images&access_token={page_token}")
                                      images = img_data.get("images", [])
                                      if images:
                                          ig_image_url = images[0].get("source")
                                      if not ig_image_url:
                                          print("IG: Could not get photo URL from legacy upload.")

                              if not ig_image_url:
                                  print("IG: No usable image URL. Skipping IG publish.")
                              else:
                                  container = api_post(
                                      f"{API}/{ig_id}/media",
                                      data={"image_url": ig_image_url, "caption": caption, "access_token": page_token}
                                  )
                                  if "error" in container:
                                      print(f"IG container error: {container['error'].get('message')}")
                                  else:
                                      time.sleep(2)
                                      pub = api_post(
                                          f"{API}/{ig_id}/media_publish",
                                          data={"creation_id": container["id"], "access_token": page_token}
                                      )
                                      if "error" in pub:
                                          print(f"IG publish error: {pub['error'].get('message')}")
                                      else:
                                          print(f"Instagram posted OK — media id: {pub.get('id')}")
                      except Exception as e:
                          print(f"Instagram exception: {e}")

                  # ── Delete the post file after attempting ──
                  delete_post_file(filepath)
                  print(f"Removed {filepath}")

              except Exception as e:
                  print(f"ERROR processing {filepath}: {e}")

          print("Done.")
          PYEOF
